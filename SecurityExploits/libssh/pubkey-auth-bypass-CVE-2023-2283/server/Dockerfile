FROM ubuntu:24.04

ENV DEBIAN_FRONTEND=noninteractive

RUN apt-get update && \
    apt-get install -y \
      sudo tmux emacs git gdb cmake build-essential net-tools psmisc \
      libssl-dev zlib1g-dev libkrb5-dev libkrb5-dbg \
      libc6-dbg

ARG UID=1000

# Create a non-root user account to run libssh.
RUN adduser victim --disabled-password --uid $UID

# Grant the 'victim' user sudo access. This is not used for the demo,
# but it is often handy for installing extra packages.
RUN adduser victim sudo
RUN echo "victim:x" | chpasswd
COPY home/ /home/victim/
RUN chown -R victim:victim /home/victim

# Switch over to the 'victim' user, since root access is no longer required
USER victim
WORKDIR /home/victim

# Clone and build libssh v0.10.4
RUN git clone https://git.libssh.org/projects/libssh.git && \
    cd libssh && \
    git checkout e8322817a9e5aaef0698d779ddd467a209a85d85 && \
    mkdir build && cd build && \
    cmake .. && \
    make -j $(nproc)

USER victim
